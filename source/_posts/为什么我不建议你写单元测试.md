---
title: 为什么我不建议你写单元测试
date: 2019-04-28 14:14:18
tags:

---



**很**明显，你已经抢了测试同学的饭碗，你知道 bug 对于 测试同学意味着什么吗？这是 KPI 啊，是工作效率啊。当测试你写的程序的时候，bug 却寥寥无几，你知道他的内心有多麽焦虑，多麽惶恐。这让会让他感到深深的挫败感，你也应该为此感到内疚。

当其他开发同学都在忙着修 bug 的时候，而你却守着 80% 几的测试覆盖率，在一边喝着茶水，一边和前台妹妹打趣，这会使同僚心生妒忌，从此结下梁子。日后你再也没有机会与这群汉子吃饭的机会，只能和妹子共进晚餐，真是太惨了！！！

质量高，会显得你很优秀，也会让老板陷入纠结，明明不想给你涨工资，却又怕你离职。就如同情窦初开貌美少女看到面相丑陋精壮汉子，虽然心里一万个不愿意，身体却无法控制。

毕竟公司请你来是为了写代码，而不是写测试。

为了不让你四面树敌，我会告诉你什么样是一个单元测试，这样你就可以成功的避开他。不要太感动，请叫我 “雷锋”！

- 有明确的预期
- 独立性
  - 时间
  - 随机数
  - 依赖顺序
- 快速的
- 没有副作用
  - 并发性
  - 基础设施（OS）
  - 持久化
  - 网络
  - ...

### 有明确的预期

你可能看到过许多的单元测试中没有任何的断言 (`Assert`)，全部是 `System.out` 或 `console.log` ，以肉眼的方式来判断是否通过。没有断言意味着没有人知道你想得到的结果是什么，即便有控制台的输出，这样的输出不能代表*正确* 或是*错误* ，一个函数固定的输入一定会有一个确定的输出不是吗？那么请把它明确出来：

```javascript
function plus(a, b) {
  return a + b;
}

// unit test
const assert = require('assert');

it('Given a = 5 And b = 6, When plus(), Then result to be 11', () => {
  const result = plus(5, 6);
  // 👎 做法：
  console.log(result);
  // 👍 做法：
  assert(result, 11);
});
```

当我们修改了 `plus` 函数的方法体（也可能是无意为之），如下：

``` javascript
function plus(a, b) {
  return a + b + 10;
}
```

当你再次运行单元测试时断言则会告诉我们与之前的预期不符，而 `console.log` 却不能。

### 独立性

一个单元测试要具备独立性，表现为两种：函数内部的独立，单元测试的独立。

被测试的函数不要依赖于外部依赖，如全局变量、时间日期、随机数等。没有外部依赖就可以做到可重复，可重复就可以自动化。

```javascript
// 全局变量
const config = { port: 8000 };
function getURL() {
  return `https://xbl.github.io:${config.port}`;
}
config.port = 9090;

// 随机数
function randomStr() {
  return Math.random().toString(16).slice(2);
}

// 日期
function getTime() {
  return Date.now();
}

```

这些外部依赖都会导致函数不可测，所以要在编码时将外部依赖抽离到参数中，或者使用一些其他办法[1]。

单元测试的独立，是指单元测试的验证结果不能依赖于其他测试。

```javascript
it('Given config port is 8080，When setPort()，Then config to be 9090', () => {
	config.setPort(9090);
  assert(config.getPort(), 9090);
});

it('Given config, When getURL(), Then result to be https://xbl.github.io:9090', () => {
	const result = config.getURL();
  assert(result, 'https://xbl.github.io:9090');
});

```

后面测试依赖于第一个测试的 `setPort` 的结果，一旦有人调整顺序或者删除上面的单元测试，后面的测试就会受到影响。

### 快速的

单元测试的目的是为了保证代码质量，如果不能及时给人们反馈结果，人们就不愿意运行它，质量就没有办法保证。所以单元测试的运行一定要快。

### 没有副作用

是的，没有副作用很难，我怎么可能告诉你世界上还有 **测试替身** 这种东西。

